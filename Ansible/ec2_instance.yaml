---
host: localhost
become: yes
become_user: root
tasks:
  - name: upgrade all packages
    yum:
      name: '*'
      state: latest
  - name: Install following packages
    yum:
      name: "{{ packages }}"
      vars:
        packages:
          - tomcat
          - python3
          - python3-pip
          - docker-engine
          - git
          - curl

tasks:
  #- ec2_instance_facts:
  # filters:
  #   - region: us-west-2
  # register: ec2_facts
  # item: "{{ ec2_facts | json_query('instances[].placement[].availability_zone') }}"

  - name: Get the current region availability
    shell: curl http://169.254.169.254/latest/meta-data/placement/availability-zone
  
  - name: Set the proxy  
    environment:
      http_proxy: https://usproxy-server.mycompany.aws:8443  
  
  - name: Copy of the local remote file
    copy:
      src: /mycompany-services.tar.gz
      dest: /temp
  - name: Extract mycompany-services.tar.gz into /data
    unarchive:
      src: /temp
      dest: /data

  - name: Start service docker and tomcat, if not started
    service:
      name: docker
      state: started
    service:
      name: tomcat
      state: started
